#!/bin/bash

# Define log file to monitor
LOG_FILE="/var/log/nginx/access.log"  # Change this to your server log file
OUTPUT_FILE="log/injection_attempts.log"
ALERT_EMAIL="admin@autosysguard.com"  # Replace with the email address to alert

# Common injection patterns
PATTERNS=(
    "UNION SELECT"  # SQL Injection
    "SELECT .* FROM"  # SQL Injection
    "DROP TABLE"  # SQL Injection
    "' OR '1'='1"  # SQL Injection
    "--"  # SQL comment-based injection
    "<script>"  # XSS Attack
    "alert("  # XSS Attack
    "; rm -rf /"  # Command Injection
    "wget http"  # Command Injection
    "curl http"  # Command Injection
)

# Timestamp
echo "Scan started at: $(date)" >> "$OUTPUT_FILE"
echo "Scanning logs for injection attempts..." | tee -a "$OUTPUT_FILE"

# Monitor the log file continuously for new entries
tail -n 0 -f "$LOG_FILE" | while read -r line; do
    # Check for patterns and log to both terminal and output file
    for PATTERN in "${PATTERNS[@]}"; do
        if echo "$line" | grep -i "$PATTERN" > /dev/null; then
            # Display the suspicious pattern and log it
            echo "Suspicious pattern detected: $PATTERN" | tee -a "$OUTPUT_FILE"
            echo "$line" | tee -a "$OUTPUT_FILE"

            # Send an alert email if necessary
            echo -e "Suspicious pattern detected in logs:\n$line" | mail -s "Injection Attempt Alert" "$ALERT_EMAIL"
        fi
    done
done
